// Prisma schema for Real-Estate project
// https://www.prisma.io/docs/concepts/components/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        String  @id @default(cuid())
  username  String? @unique @db.VarChar(50)
  email     String  @unique @db.VarChar(255)
  password  String? @db.VarChar(255)
  googleId  String? @unique @db.VarChar(255)
  firstName String? @db.VarChar(100)
  lastName  String? @db.VarChar(100)
  phone     String? @db.VarChar(20)
  location  String? @db.VarChar(255)
  bio       String? @db.Text
  avatar    String? @db.VarChar(1024)
  provider  String  @default("local") @db.VarChar(20)

  properties          Property[]     @relation("UserProperties")
  inquiries           Inquiry[]
  favorites           Favorite[]
  buyerConversations  Conversation[] @relation("BuyerConversations")
  sellerConversations Conversation[] @relation("SellerConversations")
  sentMessages        Message[]      @relation("SentMessages")
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  @@map("users")
}

// Properties table
model Property {
  id                 String            @id @default(cuid())
  title              String?           @db.VarChar(255)
  description        String?           @db.Text
  price              Decimal?          @db.Decimal(12, 2)
  verificationStatus String            @default("pending") @db.VarChar(20)
  ownerId            String?
  owner              User?             @relation(fields: [ownerId], references: [id], name: "UserProperties")
  address            Address?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  images             PropertyImage[]
  features           PropertyFeature[]
  inquiries          Inquiry[]
  favorites          Favorite[]
  conversations      Conversation[]

  @@map("properties")
}

model Address {
  id         String   @id @default(cuid())
  property   Property @relation(fields: [propertyId], references: [id])
  propertyId String   @unique
  street     String?  @db.VarChar(255)
  city       String?  @db.VarChar(100)
  state      String?  @db.VarChar(100)
  zipCode    String?  @db.VarChar(20)
  country    String?  @db.VarChar(100)

  @@map("addresses")
}

model PropertyImage {
  id         String   @id @default(cuid())
  property   Property @relation(fields: [propertyId], references: [id])
  propertyId String
  url        String   @db.VarChar(1024)
  order      Int      @default(0)
  isPrimary  Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@map("property_images")
}

model Feature {
  id         String            @id @default(cuid())
  name       String            @unique @db.VarChar(100)
  properties PropertyFeature[]

  @@map("features")
}

model PropertyFeature {
  id         String   @id @default(cuid())
  property   Property @relation(fields: [propertyId], references: [id])
  propertyId String
  feature    Feature  @relation(fields: [featureId], references: [id])
  featureId  String

  @@unique([propertyId, featureId])
  @@map("property_features")
}

model Inquiry {
  id         String   @id @default(cuid())
  property   Property @relation(fields: [propertyId], references: [id])
  propertyId String
  user       User?    @relation(fields: [userId], references: [id])
  userId     String?
  name       String   @db.VarChar(200)
  email      String   @db.VarChar(255)
  message    String   @db.Text
  createdAt  DateTime @default(now())

  @@map("inquiries")
}

model Favorite {
  id         String   @id @default(cuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  property   Property @relation(fields: [propertyId], references: [id])
  propertyId String
  createdAt  DateTime @default(now())

  @@unique([userId, propertyId])
  @@map("favorites")
}

model AdminConfig {
  id        String   @id @default(cuid())
  key       String   @unique @db.VarChar(100)
  value     String   @db.VarChar(255)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_config")
}

model Conversation {
  id            String    @id @default(cuid())
  propertyId    String
  property      Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  buyerId       String
  buyer         User      @relation(fields: [buyerId], references: [id], name: "BuyerConversations", onDelete: Cascade)
  sellerId      String
  seller        User      @relation(fields: [sellerId], references: [id], name: "SellerConversations", onDelete: Cascade)
  lastMessageAt DateTime  @default(now())
  createdAt     DateTime  @default(now())
  messages      Message[]

  @@unique([propertyId, buyerId, sellerId])
  @@map("conversations")
}

model Message {
  id             String       @id @default(cuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  sender         User         @relation(fields: [senderId], references: [id], name: "SentMessages", onDelete: Cascade)
  text           String       @db.Text
  isRead         Boolean      @default(false)
  createdAt      DateTime     @default(now())

  @@map("messages")
}

model AdminSettings {
  id        String   @id @default(cuid())
  key       String   @unique @db.VarChar(100)
  value     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admin_settings")
}
